#!/usr/bin/env -S uv run --quiet --script
# /// script
# requires-python = ">=3.11"
# dependencies = []
# ///

"""
Fetch and filter human review comments from a GitHub PR.

This script uses the GitHub CLI (gh) to fetch PR review comments,
filtering out bot comments and providing structured output.
"""

import json
import subprocess
import sys
from typing import Any, TypedDict


class ReviewComment(TypedDict):
    """Type definition for a review summary comment."""

    state: str
    submitted_at: str
    author: str
    body: str


class InlineComment(TypedDict):
    """Type definition for an inline review comment."""

    path: str
    line: int | str | None
    author: str
    body: str


def is_bot_user(user_data: dict[str, Any]) -> bool:
    """Check if a user is a bot based on user type or login name."""
    user_type = user_data.get("type", "")
    login = user_data.get("login", "")
    return user_type == "Bot" or login.endswith("[bot]")


def fetch_review_summaries(
    pr_number: str, repo: str | None = None, include_bots: bool = False
) -> list[ReviewComment]:
    """
    Fetch high-level review summaries (approve, request changes, comment).

    Args:
        pr_number: The GitHub PR number
        repo: Optional repository in owner/repo format (defaults to current repo)
        include_bots: If True, include bot reviews (default: False)

    Returns:
        List of review comment dictionaries
    """
    try:
        api_path = (
            f"repos/{repo}/pulls/{pr_number}/reviews"
            if repo
            else f"repos/:owner/:repo/pulls/{pr_number}/reviews"
        )
        result = subprocess.run(
            [
                "gh",
                "api",
                api_path,
                "--paginate",
            ],
            capture_output=True,
            text=True,
            check=True,
        )

        reviews = json.loads(result.stdout)
        human_reviews: list[ReviewComment] = []

        for review in reviews:
            # Skip bot reviews unless include_bots is True
            if not include_bots and is_bot_user(review.get("user", {})):
                continue

            # Only include reviews with actual body text
            body = review.get("body", "").strip()
            if not body:
                continue

            human_reviews.append(
                {
                    "state": review.get("state", ""),
                    "submitted_at": review.get("submitted_at", ""),
                    "author": review["user"]["login"],
                    "body": body,
                }
            )

        return human_reviews

    except subprocess.CalledProcessError as e:
        print(f"Error fetching review summaries: {e.stderr}", file=sys.stderr)
        return []
    except json.JSONDecodeError as e:
        print(f"Error parsing review summaries JSON: {e}", file=sys.stderr)
        return []


def fetch_inline_comments(
    pr_number: str, repo: str | None = None, include_bots: bool = False
) -> list[InlineComment]:
    """
    Fetch inline code review comments.

    Args:
        pr_number: The GitHub PR number
        repo: Optional repository in owner/repo format (defaults to current repo)
        include_bots: If True, include bot comments (default: False)

    Returns:
        List of inline comment dictionaries
    """
    try:
        api_path = (
            f"repos/{repo}/pulls/{pr_number}/comments"
            if repo
            else f"repos/:owner/:repo/pulls/{pr_number}/comments"
        )
        result = subprocess.run(
            [
                "gh",
                "api",
                api_path,
                "--paginate",
            ],
            capture_output=True,
            text=True,
            check=True,
        )

        comments = json.loads(result.stdout)
        human_comments: list[InlineComment] = []

        for comment in comments:
            # Skip bot comments unless include_bots is True
            if not include_bots and is_bot_user(comment.get("user", {})):
                continue

            # Get line number (try different fields as they vary by comment type)
            line = comment.get("line") or comment.get("original_line") or comment.get("position")

            human_comments.append(
                {
                    "path": comment.get("path", ""),
                    "line": line,
                    "author": comment["user"]["login"],
                    "body": comment.get("body", ""),
                }
            )

        return human_comments

    except subprocess.CalledProcessError as e:
        print(f"Error fetching inline comments: {e.stderr}", file=sys.stderr)
        return []
    except json.JSONDecodeError as e:
        print(f"Error parsing inline comments JSON: {e}", file=sys.stderr)
        return []


def main() -> None:
    """Main entry point for the script."""
    if len(sys.argv) < 2:
        print(
            "Usage: fetch-pr-comments <PR_NUMBER> [OWNER/REPO] [--include-bots]",
            file=sys.stderr,
        )
        sys.exit(1)

    # Parse arguments
    args = sys.argv[1:]
    include_bots = "--include-bots" in args
    if include_bots:
        args.remove("--include-bots")

    pr_number = args[0]
    repo = args[1] if len(args) > 1 else None

    # Set labels based on whether bots are included
    filter_label = "All" if include_bots else "Human Only"
    no_results_prefix = "No" if include_bots else "No human"

    print(f"=== REVIEW SUMMARIES ({filter_label}) ===")
    reviews = fetch_review_summaries(pr_number, repo, include_bots)
    if reviews:
        for review in reviews:
            print(json.dumps(review, indent=2))
    else:
        print(f"{no_results_prefix} review summaries found.")

    print(f"\n=== INLINE REVIEW COMMENTS ({filter_label}) ===")
    comments = fetch_inline_comments(pr_number, repo, include_bots)
    if comments:
        for comment in comments:
            print(json.dumps(comment, indent=2))
    else:
        print(f"{no_results_prefix} inline comments found.")


if __name__ == "__main__":
    main()
